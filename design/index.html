
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../arc_hbr/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.7">
    
    
      
        <title>PyHBR Design - PyHBR Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f2e4d321.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pyhbr-design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PyHBR Docs" class="md-header__button md-logo" aria-label="PyHBR Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyHBR Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PyHBR Design
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PyHBR Docs" class="md-nav__button md-logo" aria-label="PyHBR Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    PyHBR Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to the PyHBR Docs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    PyHBR Design
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    PyHBR Design
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-sources-and-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Data Sources and Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Sources and Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql-queries" class="md-nav__link">
    <span class="md-ellipsis">
      SQL Queries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#middle-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Middle Layer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Middle Layer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#episodes" class="md-nav__link">
    <span class="md-ellipsis">
      Episodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-groups" class="md-nav__link">
    <span class="md-ellipsis">
      Code Groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#codes" class="md-nav__link">
    <span class="md-ellipsis">
      Codes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demographics" class="md-nav__link">
    <span class="md-ellipsis">
      Demographics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#laboratory-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Laboratory Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prescriptions" class="md-nav__link">
    <span class="md-ellipsis">
      Prescriptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collections-of-dataframes" class="md-nav__link">
    <span class="md-ellipsis">
      Collections of DataFrames
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datamodelanalysis-save-points" class="md-nav__link">
    <span class="md-ellipsis">
      Data/Model/Analysis Save Points
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data/Model/Analysis Save Points">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#saving-data" class="md-nav__link">
    <span class="md-ellipsis">
      Saving Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-data" class="md-nav__link">
    <span class="md-ellipsis">
      Loading Data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clinical-codes" class="md-nav__link">
    <span class="md-ellipsis">
      Clinical Codes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Clinical Codes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#counting-codes" class="md-nav__link">
    <span class="md-ellipsis">
      Counting Codes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Counting Codes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-clinical-code-data" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Clinical Code Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#codes-in-other-episodes-relative-to-a-base-episode" class="md-nav__link">
    <span class="md-ellipsis">
      Codes in Other Episodes Relative to a Base Episode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#counting-codes-group-occurrences" class="md-nav__link">
    <span class="md-ellipsis">
      Counting Codes Group Occurrences
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../arc_hbr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ARC HBR Calculation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../modelling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bleeding/Ischaemia Risk Modelling
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../verification/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bleeding/Ischaemia Risk Estimate Verification
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PyHBR Function Reference
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-sources-and-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Data Sources and Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Sources and Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sql-queries" class="md-nav__link">
    <span class="md-ellipsis">
      SQL Queries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#middle-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Middle Layer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Middle Layer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#episodes" class="md-nav__link">
    <span class="md-ellipsis">
      Episodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-groups" class="md-nav__link">
    <span class="md-ellipsis">
      Code Groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#codes" class="md-nav__link">
    <span class="md-ellipsis">
      Codes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demographics" class="md-nav__link">
    <span class="md-ellipsis">
      Demographics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#laboratory-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Laboratory Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prescriptions" class="md-nav__link">
    <span class="md-ellipsis">
      Prescriptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collections-of-dataframes" class="md-nav__link">
    <span class="md-ellipsis">
      Collections of DataFrames
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datamodelanalysis-save-points" class="md-nav__link">
    <span class="md-ellipsis">
      Data/Model/Analysis Save Points
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data/Model/Analysis Save Points">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#saving-data" class="md-nav__link">
    <span class="md-ellipsis">
      Saving Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-data" class="md-nav__link">
    <span class="md-ellipsis">
      Loading Data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clinical-codes" class="md-nav__link">
    <span class="md-ellipsis">
      Clinical Codes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Clinical Codes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#counting-codes" class="md-nav__link">
    <span class="md-ellipsis">
      Counting Codes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Counting Codes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-clinical-code-data" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Clinical Code Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#codes-in-other-episodes-relative-to-a-base-episode" class="md-nav__link">
    <span class="md-ellipsis">
      Codes in Other Episodes Relative to a Base Episode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#counting-codes-group-occurrences" class="md-nav__link">
    <span class="md-ellipsis">
      Counting Codes Group Occurrences
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="pyhbr-design">PyHBR Design</h1>
<p>This section describes the design of PyHBR and how the code is structured.</p>
<h2 id="data-sources-and-analysis">Data Sources and Analysis</h2>
<p>The package contains routines for performing data analysis and fitting models. The source data for this analysis are tables stored in Microsoft SQL Server.</p>
<p>In order to make the models reusable, the analysis/model code expects the tables in a particular format, which is documented for each analysis/model script. The code for analysis is in the <code>pyhbr.analysis</code> module.</p>
<p>The database query and data fetch is performed by separate code, which is expected to be modified to port this package to a new data source. These data collection scripts are stored in the <code>pyhbr.data_source</code> module.</p>
<p>A middle preprocessing layer <code>pyhbr.middle</code> is used to converted raw data from the data sources into the form expected by analysis. This helps keep the raw data sources clean (there is no need for extensive transformations in the SQL layer).</p>
<h3 id="sql-queries">SQL Queries</h3>
<p>The approach taken to prepare SQL statements is to use SQLAlchemy to prepare a query, and then pass it to Pandas <a href="https://pandas.pydata.org/docs/reference/api/pandas.read_sql.html">read_sql</a> for execution. The advantage of using SQLAlchemy statements instead of raw strings in <code>read_sql</code> is the ability to construct statements using a declarative syntax (including binding parameters), and increased opportunity for error checking (which may be useful for porting the scripts to new databases).</p>
<p>An example of how SQL statements are built is shown below:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span> <span class="nn">pyhbr.common</span> <span class="kn">import</span> <span class="n">make_engine</span><span class="p">,</span> <span class="n">CheckedTable</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># All interactions with the database (including building queries,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c1"># which queries the server to check columns) needs an sqlalchemy </span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="c1"># engine</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="n">engine</span> <span class="o">=</span> <span class="n">make_engine</span><span class="p">()</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="c1"># The CheckedTable is a simple wrapper around sqlalchemy.Table,</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="c1"># for the purpose of checking for missing columns. It replaces</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="c1"># sqlalchemy syntax table.c.column_name with table.col(&quot;column_name&quot;)</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="n">table</span> <span class="o">=</span> <span class="n">CheckedTable</span><span class="p">(</span><span class="s2">&quot;cv1_episodes&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="c1"># The SQL statement is built up using the sqlalchemy select function.</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="c1"># The declarative syntax reduces the chance of errors typing a raw</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="c1"># SQL string. This line will throw an error if any of the columns are</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="c1"># wrong.</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;subject&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">),</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;episode_identifier&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;episode_id&quot;</span><span class="p">),</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;spell_identifier&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;spell_id&quot;</span><span class="p">),</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;episode_start_time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;episode_start&quot;</span><span class="p">),</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;episode_end_time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;episode_end&quot;</span><span class="p">),</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;episode_start_time&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>    <span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;episode_end_time&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="p">)</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="c1"># The SQL query can be printed for inspection if required,</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="c1"># or for using directly in a SQL script</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="c1"># Otherwise, execute the query using pandas to get a dataframe</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
</span></code></pre></div>
<p>See the <code>pyhbr.data_source</code> module for more examples of functions that return the <code>stmt</code> variable for different tables.</p>
<p>The following are some tips for building statements using the <code>CheckedTable</code> object:</p>
<ul>
<li><code>CheckedTable</code> contains the SQLAlchemy <code>Table</code> as the <code>table</code> member. This means you can use <code>select(table.table)</code> to initially fetch all the columns (useful for seeing what the table contains)</li>
<li>If you need to rename a column (using <code>AS</code> in SQL), use <code>label</code>; e.g. <code>select(table.col("old_name").label("new_name"))</code>.</li>
<li>Sometimes (particularly with ID columns which are typed incorrectly), it is useful to be able to cast to a different type. You can do this using <code>select(table.col("col_to_cast").cast(String))</code>. The list of generic types is provided <a href="https://docs.sqlalchemy.org/en/20/core/type_basics.html#generic-camelcase-types">here</a>; import the one you need using a line like <code>from sqlalchemy import String</code>.</li>
</ul>
<h3 id="middle-layer">Middle Layer</h3>
<p>To account for differences in data sources and the analysis, the module <code>pyhbr.middle</code> contains modules like <code>from_hic</code> which contain function that return transformed versions of the data sources more suitable for analysis.</p>
<p>The outputs from this layer are documented here so that it is possible to take a new data source and write a new module in <code>pyhbr.middle</code> which exposes the new data source for analysis. These tables are grouped together into classes and (where the table name is used as the attribute name) used as the argument to analysis functions. Analysis functions may not use all the columns of each table, but when a column is present it should have the name and meaning given below.</p>
<p>All tables are Pandas DataFrames.</p>
<h4 id="episodes">Episodes</h4>
<p>Episodes correspond to individual consultant interactions within a hospital visit (called a spell). Episode information is stored in a table called <code>episodes</code>, which has the following columns:</p>
<ul>
<li><code>episode_id</code> (<code>str</code>, Pandas index): uniquely identifies the episode.</li>
<li><code>patient_id</code> (<code>str</code>): the unique identifier for the patient.</li>
<li><code>spell_id</code> (<code>str</code>): identifies the spell containing the episode.</li>
<li><code>episode_start</code> (<code>datetime.date</code>): the episode start time.</li>
<li><code>age</code> (<code>float64</code>): The patient age at the start of the episode. </li>
<li><code>gender</code> (<code>category</code>): One of "male", "female", or "unknown". </li>
</ul>
<p>Even though age and gender are demographic properties, it is convenient to keep them in the episodes table because they are eventually stored with index events, which come directly from episodes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Consider filtering the episodes table based on a date range of interest when it is fetched from the data source. This will speed up subsequent processing.</p>
</div>
<h4 id="code-groups">Code Groups</h4>
<p>A table of code groups is required as input to functions to identify patients based on aspects of their coded history. This table is called <code>code_groups</code>, and has the following structure:</p>
<ul>
<li><code>code</code> (<code>str</code>): The ICD-10 or OPCS-4 code in normalised form (e.g. "i200")</li>
<li><code>codes</code> (<code>str</code>): The description of the code</li>
<li><code>group</code> (<code>str</code>): The name of the code group containing the code</li>
<li><code>type</code> (<code>category</code>): One of "diagnosis" (for ICD-10 codes) or "procedure" (for OPCS-4 codes)</li>
</ul>
<p>Only codes which are in a code group are included in the table. Codes may be present in multiple rows if they occur in multiple groups.</p>
<h4 id="codes">Codes</h4>
<p>Episodes contain clinical code data, which lists the diagnoses made and the procedures performed in an episode. This is stored in a table called <code>codes</code>, with the following columns:</p>
<ul>
<li><code>episode_id</code> (<code>str</code>): which episode contains this clinical code.</li>
<li><code>code</code> (<code>str</code>): the clinical code, all lowercase with no whitespace or dot, e.g. <code>i212</code></li>
<li><code>position</code> (<code>int</code>): the position of the code in the episode. 1 means the primary position (e.g. for a primary diagnosis), and &gt;1 means a secondary code. Often episodes contain 5-10 clinical codes, and the maximum number depends on the data source.</li>
<li><code>type</code> (<code>category</code>): either "diagnosis" (for ICD-10 diagnosis codes) or "procedure" (for OPCS-4 codes)</li>
<li><code>group</code> (<code>str</code>): which group contains this clinical code.</li>
</ul>
<p>The Pandas index is a unique integer (note that <code>episode_id</code> is not unique, since a single episode can contain many codes).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This table only contains codes that are in a code group (i.e. the function making <code>codes</code> should filter out codes not in any group; the <code>group</code> column is not NaN). If all codes are required, make a code group "all" which contains every code. Note that codes occupy multiple rows in the <code>codes</code> table if they are in more than one group (take care when counting rows). In these cases, a duplicate code is identified by having the same <code>code</code>, <code>position</code> and <code>type</code> values, but a different group.</p>
</div>
<h4 id="demographics">Demographics</h4>
<p>Demographic information is stored in a table called <code>demographics</code>, which has the following columns:</p>
<ul>
<li><code>patient_id</code> (<code>str</code>, Pandas index): the unique patient identifier</li>
<li><code>gender</code> (<code>category</code>): One of "male", "female", or "unknown". </li>
</ul>
<h4 id="laboratory-tests">Laboratory Tests</h4>
<p>Write me please</p>
<h4 id="prescriptions">Prescriptions</h4>
<p>Write me please</p>
<h4 id="collections-of-dataframes">Collections of DataFrames</h4>
<p>Once the data source has been converted into the standard form described above, multiple tables are collected together into a dictionary mapping strings to Pandas DataFrames. The value of the keys matches the table name in the sections above.</p>
<h2 id="datamodelanalysis-save-points">Data/Model/Analysis Save Points</h2>
<p>To support saving intermediate results of calculations, <code>pyhbr.common</code> includes two functions <code>save_item</code> and <code>load_item</code>, which save a Python object to a directory (by default <code>save_data/</code> in your working directory).</p>
<p>The scripts in <a href="https://github.com/jrs0/hbr_uhbw">hbr_uhbw</a> use these functions to create these checkpoints:</p>
<ul>
<li><strong>Data</strong>: After fetching data from databases or data sources and converting it into the raw format suitable for modelling or analysis. These files have <code>_data</code> in the file name. This data is then loaded again for modelling or analysis</li>
<li><strong>Model</strong>: After training models using the data stored in the <code>_data</code> files. These files have <code>_model</code> in the file name. This data is loaded for analysis.</li>
<li><strong>Analysis</strong>: After performing analysis using the <code>_data</code> or <code>_model</code> files. These files have <code>_analysis</code> in the file name. This data can be loaded and used to generate reports/outputs.</li>
</ul>
<p>Splitting up the scripts in this way makes them easier to develop, because each of the three parts above can take quite long to run.</p>
<p>Multiple objects can be saved under one file by including them in a dictionary. It is up to the script to determine the format of the items being saved and loaded.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>By default, <code>save_item</code> puts the saved files into a directory called <code>save_data/</code> relative to your current working directory. Ensure that this is added to the .gitignore if the files contain sensitive data, to avoid committing them to your repository.</p>
</div>
<h4 id="saving-data">Saving Data</h4>
<p>In addition to saving the item, <code>pyhbr.common.save_item</code> also includes in the file name:</p>
<ul>
<li>The commit hash of the git repository at the time <code>save_item</code> is called. This is intended to make it easier to reproduce the state of the repository that generated the file. By default, <code>save_item</code> requires you to commit any changes before saving a file. (The cleanest/most reproducible thing to do is commit changes, and then run a script non-interactively from the top.) If you are not using a git repository, then "nogit" is used in place of the commit hash.</li>
<li>The timestamp when <code>save_item</code> was called, which is more granular than the commit hash (or useful in case you do not have a git repository).</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can save multiple items with the same name, because the file names will use different timestamps. By default, <code>load_item</code> will load the most recently saved file with a given name.</p>
</div>
<p>The <code>save_item</code> function is shown below. The simplest way to call it is <code>save_item(df, "my_df")</code>, which will save the DataFrame <code>df</code> to the directory <code>save_data/</code> using the name "my_df".</p>
<details class="note">
<summary>Use this function to save a Python object (e.g. a DataFrame)</summary>



<div class="doc doc-object doc-function">



<h100 id="pyhbr.common.save_item" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>          <code class="highlight language-python"><span class="n">save_item</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="s1">&#39;save_data/&#39;</span><span class="p">,</span> <span class="n">enforce_clean_branch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prompt_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h100>


  <div class="doc doc-contents first">
  
      <p>Save an item to a pickle file</p>
<p>Saves a python object (e.g. a pandas DataFrame) dataframe in the save_dir
folder, using a filename that includes the current timestamp and the current
commit hash. Use load_item to retrieve the file.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Ensure that <code>save_data/</code> (or your chosen <code>save_dir</code>) is added to the
.gitignore of your repository to ensure sensitive data is not committed.</p>
</div>
<p>By storing the commit hash and timestamp, it is possible to identify when items
were created and what code created them. To make most effective use of the
commit hash, ensure that you commit, and do not make any further code edits,
before running a script that calls save_item (otherwise the commit hash will
not quite reflect the state of the running code).</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>item</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The python object to save (e.g. pandas DataFrame)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the item. The filename will be created by adding
a suffix for the current commit and the timestamp to show when the
data was saved (format: <code>name_commit_timestamp.pkl</code>)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>save_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Where to save the data, relative to the current working directory.
The directory will be created if it does not exist.</p>
            </div>
          </td>
          <td>
                <code>&#39;save_data/&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>enforce_clean_branch</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If True, the function will raise an exception if an attempt
is made to save an item when the repository has uncommitted changes.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>prompt_commit</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if enforce_clean_branch is true, choose whether the prompt the
user to commit on an unclean branch. This can help avoiding losing
the results of a long-running script. Prefer to use false if the script
is cheap to run.</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src\pyhbr\common.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-366"><a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="k">def</span> <span class="nf">save_item</span><span class="p">(</span>
</span><span id="__span-0-367"><a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-0-368"><a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-369"><a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;save_data/&quot;</span><span class="p">,</span>
</span><span id="__span-0-370"><a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="n">enforce_clean_branch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-0-371"><a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="n">prompt_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-0-372"><a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-373"><a id="__codelineno-0-373" name="__codelineno-0-373"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Save an item to a pickle file</span>
</span><span id="__span-0-374"><a id="__codelineno-0-374" name="__codelineno-0-374"></a>
</span><span id="__span-0-375"><a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">    Saves a python object (e.g. a pandas DataFrame) dataframe in the save_dir</span>
</span><span id="__span-0-376"><a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="sd">    folder, using a filename that includes the current timestamp and the current</span>
</span><span id="__span-0-377"><a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="sd">    commit hash. Use load_item to retrieve the file.</span>
</span><span id="__span-0-378"><a id="__codelineno-0-378" name="__codelineno-0-378"></a>
</span><span id="__span-0-379"><a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">    !!! important</span>
</span><span id="__span-0-380"><a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">        Ensure that `save_data/` (or your chosen `save_dir`) is added to the</span>
</span><span id="__span-0-381"><a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">        .gitignore of your repository to ensure sensitive data is not committed.</span>
</span><span id="__span-0-382"><a id="__codelineno-0-382" name="__codelineno-0-382"></a>
</span><span id="__span-0-383"><a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">    By storing the commit hash and timestamp, it is possible to identify when items</span>
</span><span id="__span-0-384"><a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">    were created and what code created them. To make most effective use of the</span>
</span><span id="__span-0-385"><a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">    commit hash, ensure that you commit, and do not make any further code edits,</span>
</span><span id="__span-0-386"><a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">    before running a script that calls save_item (otherwise the commit hash will</span>
</span><span id="__span-0-387"><a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">    not quite reflect the state of the running code).</span>
</span><span id="__span-0-388"><a id="__codelineno-0-388" name="__codelineno-0-388"></a>
</span><span id="__span-0-389"><a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">    Args:</span>
</span><span id="__span-0-390"><a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">        item: The python object to save (e.g. pandas DataFrame)</span>
</span><span id="__span-0-391"><a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">        name: The name of the item. The filename will be created by adding</span>
</span><span id="__span-0-392"><a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">            a suffix for the current commit and the timestamp to show when the</span>
</span><span id="__span-0-393"><a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">            data was saved (format: `name_commit_timestamp.pkl`)</span>
</span><span id="__span-0-394"><a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        save_dir: Where to save the data, relative to the current working directory.</span>
</span><span id="__span-0-395"><a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">            The directory will be created if it does not exist.</span>
</span><span id="__span-0-396"><a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">        enforce_clean_branch: If True, the function will raise an exception if an attempt</span>
</span><span id="__span-0-397"><a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">            is made to save an item when the repository has uncommitted changes.</span>
</span><span id="__span-0-398"><a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">        prompt_commit: if enforce_clean_branch is true, choose whether the prompt the</span>
</span><span id="__span-0-399"><a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">            user to commit on an unclean branch. This can help avoiding losing</span>
</span><span id="__span-0-400"><a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">            the results of a long-running script. Prefer to use false if the script</span>
</span><span id="__span-0-401"><a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">            is cheap to run.</span>
</span><span id="__span-0-402"><a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-0-403"><a id="__codelineno-0-403" name="__codelineno-0-403"></a>
</span><span id="__span-0-404"><a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="k">if</span> <span class="n">enforce_clean_branch</span><span class="p">:</span>
</span><span id="__span-0-405"><a id="__codelineno-0-405" name="__codelineno-0-405"></a>
</span><span id="__span-0-406"><a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">abort_msg</span> <span class="o">=</span> <span class="s2">&quot;Aborting save_item() because branch is not clean. Commit your changes before saving item to increase the chance of reproducing the item based on the filename commit hash.&quot;</span>
</span><span id="__span-0-407"><a id="__codelineno-0-407" name="__codelineno-0-407"></a>
</span><span id="__span-0-408"><a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="k">if</span> <span class="n">prompt_commit</span><span class="p">:</span>
</span><span id="__span-0-409"><a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="c1"># If the branch is not clean, prompt the user to commit to avoid losing</span>
</span><span id="__span-0-410"><a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="c1"># long-running model results. Take care to only commit if the state of</span>
</span><span id="__span-0-411"><a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="c1"># the repository truly reflects what was run (i.e. if no changes were made</span>
</span><span id="__span-0-412"><a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="c1"># while the script was running).</span>
</span><span id="__span-0-413"><a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="k">while</span> <span class="n">requires_commit</span><span class="p">():</span>
</span><span id="__span-0-414"><a id="__codelineno-0-414" name="__codelineno-0-414"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">abort_msg</span><span class="p">)</span>
</span><span id="__span-0-415"><a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="nb">print</span><span class="p">(</span>
</span><span id="__span-0-416"><a id="__codelineno-0-416" name="__codelineno-0-416"></a>                    <span class="s2">&quot;You can commit now and then retry the save after committing.&quot;</span>
</span><span id="__span-0-417"><a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="p">)</span>
</span><span id="__span-0-418"><a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="n">retry_save</span> <span class="o">=</span> <span class="n">query_yes_no</span><span class="p">(</span>
</span><span id="__span-0-419"><a id="__codelineno-0-419" name="__codelineno-0-419"></a>                    <span class="s2">&quot;Do you want to retry the save? Commit, then select yes, or choose no to abort the save.&quot;</span>
</span><span id="__span-0-420"><a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="p">)</span>
</span><span id="__span-0-421"><a id="__codelineno-0-421" name="__codelineno-0-421"></a>
</span><span id="__span-0-422"><a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">retry_save</span><span class="p">:</span>
</span><span id="__span-0-423"><a id="__codelineno-0-423" name="__codelineno-0-423"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aborting save of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-0-424"><a id="__codelineno-0-424" name="__codelineno-0-424"></a>                    <span class="k">return</span>
</span><span id="__span-0-425"><a id="__codelineno-0-425" name="__codelineno-0-425"></a>
</span><span id="__span-0-426"><a id="__codelineno-0-426" name="__codelineno-0-426"></a>            <span class="c1"># If we get out the loop without returning, then the branch</span>
</span><span id="__span-0-427"><a id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="c1"># is not clean and the save can proceed.</span>
</span><span id="__span-0-428"><a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Branch now clean, proceeding to save&quot;</span><span class="p">)</span>
</span><span id="__span-0-429"><a id="__codelineno-0-429" name="__codelineno-0-429"></a>
</span><span id="__span-0-430"><a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-431"><a id="__codelineno-0-431" name="__codelineno-0-431"></a>
</span><span id="__span-0-432"><a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="k">if</span> <span class="n">requires_commit</span><span class="p">():</span>
</span><span id="__span-0-433"><a id="__codelineno-0-433" name="__codelineno-0-433"></a>                <span class="c1"># In this case, unconditionally throw an error</span>
</span><span id="__span-0-434"><a id="__codelineno-0-434" name="__codelineno-0-434"></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">abort_msg</span><span class="p">)</span>
</span><span id="__span-0-435"><a id="__codelineno-0-435" name="__codelineno-0-435"></a>
</span><span id="__span-0-436"><a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="__span-0-437"><a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating missing folder &#39;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">&#39; for storing item&quot;</span><span class="p">)</span>
</span><span id="__span-0-438"><a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-439"><a id="__codelineno-0-439" name="__codelineno-0-439"></a>
</span><span id="__span-0-440"><a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="n">path</span> <span class="o">=</span> <span class="n">make_new_save_item_path</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;pkl&quot;</span><span class="p">)</span>
</span><span id="__span-0-441"><a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="__span-0-442"><a id="__codelineno-0-442" name="__codelineno-0-442"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-0-443"><a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
          </details>
  </div>

</div></details>
<h4 id="loading-data">Loading Data</h4>
<p>To load a previously saved item, using <code>pyhbr.common.load_item</code>. It can be called most simply using <code>load_item("my_df")</code>, assuming you previously saved an object in the default directory (<code>save_data</code>) with the name "my_df". By default, the most recent item is loaded, but using <code>load_item("my_df", True)</code> will let you pick which file you want to load.</p>
<p>The function <code>load_item</code> is shown below:</p>
<details class="note">
<summary>Use this function to load a previously saved Python object</summary>



<div class="doc doc-object doc-function">



<h100 id="pyhbr.common.load_item" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>          <code class="highlight language-python"><span class="n">load_item</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="s1">&#39;save_data&#39;</span><span class="p">)</span></code>

</h100>


  <div class="doc doc-contents first">
  
      <p>Load a previously saved item (pickle) from file</p>
<p>Use this function to load a file that was previously saved using
save_item(). By default, the latest version of the item will be returned
(the one with the most recent timestamp).</p>
<p>None is returned if an interactive load is cancelled by the user.</p>
<p>To load an item that is an object from a library (e.g. a pandas DataFrame),
the library must be installed (otherwise you will get a ModuleNotFound
exception). However, you do not have to import the library before calling this
function.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the item to load</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>interactive</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If True, let the user pick which item version to load interactively.
If False, non-interactively load the most recent item (i.e. with the most
recent timestamp). The commit hash is not considered when loading the item.</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>save_fir</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Which folder to load the item from.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>(<span title="typing.Any">Any</span>, <span title="pathlib.Path">Path</span>)</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple, with the python object loaded from file as first element and the
Path to the item as the second element, or None if the user cancelled
an interactive load.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src\pyhbr\common.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-445"><a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="k">def</span> <span class="nf">load_item</span><span class="p">(</span>
</span><span id="__span-0-446"><a id="__codelineno-0-446" name="__codelineno-0-446"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interactive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;save_data&quot;</span>
</span><span id="__span-0-447"><a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
</span><span id="__span-0-448"><a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a previously saved item (pickle) from file</span>
</span><span id="__span-0-449"><a id="__codelineno-0-449" name="__codelineno-0-449"></a>
</span><span id="__span-0-450"><a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">    Use this function to load a file that was previously saved using</span>
</span><span id="__span-0-451"><a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">    save_item(). By default, the latest version of the item will be returned</span>
</span><span id="__span-0-452"><a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">    (the one with the most recent timestamp).</span>
</span><span id="__span-0-453"><a id="__codelineno-0-453" name="__codelineno-0-453"></a>
</span><span id="__span-0-454"><a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">    None is returned if an interactive load is cancelled by the user.</span>
</span><span id="__span-0-455"><a id="__codelineno-0-455" name="__codelineno-0-455"></a>
</span><span id="__span-0-456"><a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">    To load an item that is an object from a library (e.g. a pandas DataFrame),</span>
</span><span id="__span-0-457"><a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">    the library must be installed (otherwise you will get a ModuleNotFound</span>
</span><span id="__span-0-458"><a id="__codelineno-0-458" name="__codelineno-0-458"></a><span class="sd">    exception). However, you do not have to import the library before calling this</span>
</span><span id="__span-0-459"><a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">    function.</span>
</span><span id="__span-0-460"><a id="__codelineno-0-460" name="__codelineno-0-460"></a>
</span><span id="__span-0-461"><a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="sd">    Args:</span>
</span><span id="__span-0-462"><a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="sd">        name: The name of the item to load</span>
</span><span id="__span-0-463"><a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="sd">        interactive: If True, let the user pick which item version to load interactively.</span>
</span><span id="__span-0-464"><a id="__codelineno-0-464" name="__codelineno-0-464"></a><span class="sd">            If False, non-interactively load the most recent item (i.e. with the most</span>
</span><span id="__span-0-465"><a id="__codelineno-0-465" name="__codelineno-0-465"></a><span class="sd">            recent timestamp). The commit hash is not considered when loading the item.</span>
</span><span id="__span-0-466"><a id="__codelineno-0-466" name="__codelineno-0-466"></a><span class="sd">        save_fir: Which folder to load the item from.</span>
</span><span id="__span-0-467"><a id="__codelineno-0-467" name="__codelineno-0-467"></a>
</span><span id="__span-0-468"><a id="__codelineno-0-468" name="__codelineno-0-468"></a><span class="sd">    Returns:</span>
</span><span id="__span-0-469"><a id="__codelineno-0-469" name="__codelineno-0-469"></a><span class="sd">        A tuple, with the python object loaded from file as first element and the</span>
</span><span id="__span-0-470"><a id="__codelineno-0-470" name="__codelineno-0-470"></a><span class="sd">            Path to the item as the second element, or None if the user cancelled</span>
</span><span id="__span-0-471"><a id="__codelineno-0-471" name="__codelineno-0-471"></a><span class="sd">            an interactive load.</span>
</span><span id="__span-0-472"><a id="__codelineno-0-472" name="__codelineno-0-472"></a>
</span><span id="__span-0-473"><a id="__codelineno-0-473" name="__codelineno-0-473"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-0-474"><a id="__codelineno-0-474" name="__codelineno-0-474"></a>    <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
</span><span id="__span-0-475"><a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="n">item_path</span> <span class="o">=</span> <span class="n">pick_saved_file_interactive</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;pkl&quot;</span><span class="p">)</span>
</span><span id="__span-0-476"><a id="__codelineno-0-476" name="__codelineno-0-476"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-0-477"><a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="n">item_path</span> <span class="o">=</span> <span class="n">pick_most_recent_saved_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="s2">&quot;pkl&quot;</span><span class="p">)</span>
</span><span id="__span-0-478"><a id="__codelineno-0-478" name="__codelineno-0-478"></a>
</span><span id="__span-0-479"><a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="k">if</span> <span class="n">item_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-0-480"><a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborted (interactive) load item&quot;</span><span class="p">)</span>
</span><span id="__span-0-481"><a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="__span-0-482"><a id="__codelineno-0-482" name="__codelineno-0-482"></a>
</span><span id="__span-0-483"><a id="__codelineno-0-483" name="__codelineno-0-483"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">item_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-0-484"><a id="__codelineno-0-484" name="__codelineno-0-484"></a>
</span><span id="__span-0-485"><a id="__codelineno-0-485" name="__codelineno-0-485"></a>    <span class="c1"># Load a generic pickle. Note that if this is a pandas dataframe,</span>
</span><span id="__span-0-486"><a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="c1"># pandas must be installed (otherwise you will get module not found).</span>
</span><span id="__span-0-487"><a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="c1"># The same goes for a pickle storing an object from any other library.</span>
</span><span id="__span-0-488"><a id="__codelineno-0-488" name="__codelineno-0-488"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">item_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="__span-0-489"><a id="__codelineno-0-489" name="__codelineno-0-489"></a>        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">item_path</span>
</span></code></pre></div></td></tr></table></div>
          </details>
  </div>

</div></details>
<h2 id="clinical-codes">Clinical Codes</h2>
<p>PyHBR has functions for creating and using lists of ICD-10 and OPCS-4 codes. A prototype version of the graphical program to create the code lists was written in Tauri <a href="https://github.com/jrs0/hbr_models">here</a>. However, it is simpler and more portable to have the codes editor bundled in this python package, and written in python.</p>
<p>Users should be able to do the following things with the codes editor GUI:</p>
<ul>
<li>Open the GUI program, and select a blank ICD-10 or OPCS-4 codes tree to begin creating code groups.</li>
<li>Create new code groups starting from the blank template.</li>
<li>Search for strings within the ICD-10/OPCS-4 descriptions to make creation of groups easier.</li>
<li>Save the resulting codes file to a working directory.</li>
<li>Open and edit a previously saved codes file from a working directory.</li>
</ul>
<p>Once the groups have been defined, the user should be able to perform the following actions with the code groups files:</p>
<ul>
<li>Import codes files from the package (i.e. predefined code groups).</li>
<li>Import codes files (containing custom groups) from a working directory.</li>
<li>Extract the code groups, and show which codes are in which groups.</li>
<li>Use the code groups in analysis (i.e. get a Pandas DataFrame showing which codes are in which groups)</li>
</ul>
<p>Multiple code groups are stored in a single file, which means that only two codes files are necessary: <code>icd10-yaml</code> and <code>opcs4.yaml</code>. There is no limit to the number of code groups.</p>
<p>Previously implemented functionality to check whether a clinical code is valid will not be implemented here, because sufficiently performant code cannot be written in pure python (and this package is intended to contain only pure Python to maximise portability).</p>
<p>Instead, all codes are converted to a standard "normal form" where upper-case letters are replaced with lower-case, and dots/whitespace is removed. Codes can then be compared, and most codes will match under this condition. (Codes that will not match include those with suffixes, such as dagger or asterix, or codes that contain further qualifying suffixes that are not present in the codes tree.).</p>
<h3 id="counting-codes">Counting Codes</h3>
<p>Diagnosis and procedure codes can be grouped together and used as features for building models. One way to do this is to count the codes in a particular time window (for example, one year before an index event), and use that as a predictor for subsequent outcomes.</p>
<p>This sections describes how raw episode data is converted into this counted form in PyHBR.</p>
<h4 id="getting-clinical-code-data">Getting Clinical Code Data</h4>
<p>Hospital episodes contain multiple diagnosis and procedure codes. The starting point for counting codes is using the <code>pyhbr.middle.*.get_clinical_codes</code> function, which returns a data frame with the following columns:</p>
<ul>
<li><code>episode_id</code>: Which episode the code was in</li>
<li><code>code</code>: The name of the clinical code in normal form (lowercase, no whitespace/dots), e.g. "n183"</li>
<li><code>group</code>: The group containing the code. The table only contains codes that are defined in a code group, which is based on the codes files from the previous section</li>
<li><code>position</code>: The priority of the clinical code, where 1 means the primary diagnosis/procedure, and &gt; 1 means a secondary code.</li>
<li><code>type</code>: Either "diagnosis" or "procedure" depending on the type of code.</li>
</ul>
<p>This table does not use <code>episode_id</code> as the index because a single episode ID often has many rows.</p>
<p>An example of this function in <code>pyhbr.middle.from_hic</code> is:</p>
<details class="note">
<summary>Example function which fetches clinical codes</summary>



<div class="doc doc-object doc-function">



<h100 id="pyhbr.middle.from_hic.get_clinical_codes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>          <code class="highlight language-python"><span class="n">get_clinical_codes</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">diagnoses_file</span><span class="p">,</span> <span class="n">procedures_file</span><span class="p">)</span></code>

</h100>


  <div class="doc doc-contents first">
  
      <p>Main diagnoses/procedures fetch for the HIC data</p>
<p>This function wraps the diagnoses/procedures queries and a filtering
operation to reduce the tables to only those rows which contain a code
in a group. One table is returned which contains both the diagnoses and
procedures in long format, along with the associated episode ID and the
primary/secondary position of the code in the episode.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>engine</code></td>
          <td>
                <code><span title="sqlalchemy.Engine">Engine</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The connection to the database</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>diagnoses_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The diagnoses codes file name (loaded from the package)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>procedures_file</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The procedures codes file name (loaded from the package)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A table containing diagnoses/procedures, normalised codes, code groups,
diagnosis positions, and associated episode ID.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src\pyhbr\middle\from_hic.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">def</span> <span class="nf">get_clinical_codes</span><span class="p">(</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">diagnoses_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">procedures_file</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main diagnoses/procedures fetch for the HIC data</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    This function wraps the diagnoses/procedures queries and a filtering</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    operation to reduce the tables to only those rows which contain a code</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    in a group. One table is returned which contains both the diagnoses and</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    procedures in long format, along with the associated episode ID and the</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    primary/secondary position of the code in the episode.</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Args:</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        engine: The connection to the database</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        diagnoses_file: The diagnoses codes file name (loaded from the package)</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        procedures_file: The procedures codes file name (loaded from the package)</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    Returns:</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        A table containing diagnoses/procedures, normalised codes, code groups,</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            diagnosis positions, and associated episode ID.</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">diagnosis_codes</span> <span class="o">=</span> <span class="n">clinical_codes</span><span class="o">.</span><span class="n">load_from_package</span><span class="p">(</span><span class="n">diagnoses_file</span><span class="p">)</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">procedures_codes</span> <span class="o">=</span> <span class="n">clinical_codes</span><span class="o">.</span><span class="n">load_from_package</span><span class="p">(</span><span class="n">procedures_file</span><span class="p">)</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="c1"># Fetch the data from the server</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">diagnoses</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">hic</span><span class="o">.</span><span class="n">diagnoses_query</span><span class="p">)</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">procedures</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">hic</span><span class="o">.</span><span class="n">procedures_query</span><span class="p">)</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="c1"># Reduce data to only code groups, and combine diagnoses/procedures</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">filtered_diagnoses</span> <span class="o">=</span> <span class="n">clinical_codes</span><span class="o">.</span><span class="n">filter_to_groups</span><span class="p">(</span><span class="n">diagnoses</span><span class="p">,</span> <span class="n">diagnosis_codes</span><span class="p">)</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">filtered_procedures</span> <span class="o">=</span> <span class="n">clinical_codes</span><span class="o">.</span><span class="n">filter_to_groups</span><span class="p">(</span><span class="n">procedures</span><span class="p">,</span> <span class="n">procedures_codes</span><span class="p">)</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="c1"># Tag the diagnoses/procedures, and combine the tables</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">filtered_diagnoses</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;diagnosis&quot;</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">filtered_procedures</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;procedure&quot;</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">codes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">filtered_diagnoses</span><span class="p">,</span> <span class="n">filtered_procedures</span><span class="p">])</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">codes</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">codes</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52"></a>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">return</span> <span class="n">codes</span>
</span></code></pre></div></td></tr></table></div>
          </details>
  </div>

</div></details>
<h4 id="codes-in-other-episodes-relative-to-a-base-episode">Codes in Other Episodes Relative to a Base Episode</h4>
<p>To count up codes that occur in a time window before or after a particular base episode, it is necessary to join together each base episode with all the other episodes for the same patient.</p>
<p>To do this, three tables are needed:</p>
<ul>
<li><code>base_episodes</code>: A table of the base episodes of interest, containing <code>episode_id</code> as an index.</li>
<li><code>episodes</code>: A table of episode information (all episodes), which is indexed by <code>episode_id</code> and contains <code>patient_id</code> and <code>episode_start</code> as columns.</li>
<li><code>codes</code>: The table of diagnosis/procedure codes from the previous section, containing a column <code>episode_id</code> and other code data columns.</li>
</ul>
<p>A function which combines these into a table containing all codes for other episodes relative to a base episode is <code>pyhbr.clinical_codes.counting.get_all_other_codes</code>:</p>
<details class="note">
<summary>Function that gets data from other episodes relative to a base episode</summary>



<div class="doc doc-object doc-function">



<h100 id="pyhbr.clinical_codes.counting.get_all_other_codes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>          <code class="highlight language-python"><span class="n">get_all_other_codes</span><span class="p">(</span><span class="n">index_spells</span><span class="p">,</span> <span class="n">episodes</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span></code>

</h100>


  <div class="doc doc-contents first">
  
      <p>For each patient, get clinical codes in other episodes before/after the index</p>
<p>This makes a table of index episodes (which is the first episode of the index spell)
along with all other episodes for a patient. Two columns <code>index_episode_id</code> and
<code>other_episode_id</code> identify the two episodes for each row (they may be equal), and
other information is stored such as the time of the base episode, the time to the
other episode, and clinical code information for the other episode.</p>
<p>This table is used as the basis for all processing involving counting codes before
and after an episode.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Episodes will not be included in the result if they do not have any clinical
    codes that are in any code group.</p>
</div>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>index_spells</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Contains <code>episode_id</code> as an index.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>episodes</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Contains <code>episode_id</code> as an index, and <code>patient_id</code> and <code>episode_start</code> as columns</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>codes</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Contains <code>episode_id</code> and other code data as columns</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A table containing columns <code>index_episode_id</code>, <code>other_episode_id</code>,
<code>index_episode_start</code>, <code>time_to_other_episode</code>, and code data columns
for the other episode. Note that the base episode itself is included
as an other episode.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src\pyhbr\clinical_codes\counting.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="k">def</span> <span class="nf">get_all_other_codes</span><span class="p">(</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="n">index_spells</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">episodes</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">codes</span><span class="p">:</span> <span class="n">DataFrame</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;For each patient, get clinical codes in other episodes before/after the index</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    This makes a table of index episodes (which is the first episode of the index spell)</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    along with all other episodes for a patient. Two columns `index_episode_id` and</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    `other_episode_id` identify the two episodes for each row (they may be equal), and</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    other information is stored such as the time of the base episode, the time to the</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    other episode, and clinical code information for the other episode.</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    This table is used as the basis for all processing involving counting codes before</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    and after an episode.</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    !!! note</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        Episodes will not be included in the result if they do not have any clinical</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">            codes that are in any code group.</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Args:</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        index_spells: Contains `episode_id` as an index.</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        episodes: Contains `episode_id` as an index, and `patient_id` and `episode_start` as columns</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        codes: Contains `episode_id` and other code data as columns</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    Returns:</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        A table containing columns `index_episode_id`, `other_episode_id`,</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            `index_episode_start`, `time_to_other_episode`, and code data columns</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            for the other episode. Note that the base episode itself is included</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            as an other episode.</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="c1"># Remove everything but the index episode_id (in case base_episodes</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># already has the columns)</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">index_spells</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="s2">&quot;spell_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;episode_id&quot;</span><span class="p">)[</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="p">[</span><span class="s2">&quot;spell_id&quot;</span><span class="p">]</span>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="p">]</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">index_episode_info</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">episodes</span><span class="p">[[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="s2">&quot;episode_start&quot;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;episode_id&quot;</span>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;episode_start&quot;</span><span class="p">:</span> <span class="s2">&quot;index_episode_start&quot;</span><span class="p">,</span> <span class="s2">&quot;spell_id&quot;</span><span class="p">:</span> <span class="s2">&quot;index_spell_id&quot;</span><span class="p">}</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="p">)</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">other_episodes</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">index_episode_info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="s2">&quot;index_episode_id&quot;</span><span class="p">)</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="n">episodes</span><span class="p">[[</span><span class="s2">&quot;episode_start&quot;</span><span class="p">,</span> <span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="s2">&quot;spell_id&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54"></a>                <span class="n">names</span><span class="o">=</span><span class="s2">&quot;other_episode_id&quot;</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="p">),</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="p">)</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;spell_id&quot;</span><span class="p">:</span> <span class="s2">&quot;other_spell_id&quot;</span><span class="p">})</span>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="p">)</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61"></a>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">other_episodes</span><span class="p">[</span><span class="s2">&quot;time_to_other_episode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">other_episodes</span><span class="p">[</span><span class="s2">&quot;episode_start&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">other_episodes</span><span class="p">[</span><span class="s2">&quot;index_episode_start&quot;</span><span class="p">]</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="p">)</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65"></a>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="c1"># Use an inner join to filter out other episodes that have no associated codes</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="c1"># in any group.</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">with_codes</span> <span class="o">=</span> <span class="n">other_episodes</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">codes</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;other_episode_id&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;episode_id&quot;</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="s2">&quot;episode_start&quot;</span><span class="p">,</span> <span class="s2">&quot;episode_id&quot;</span><span class="p">])</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71"></a>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">return</span> <span class="n">with_codes</span>
</span></code></pre></div></td></tr></table></div>
          </details>
  </div>

</div></details>
<h4 id="counting-codes-group-occurrences">Counting Codes Group Occurrences</h4>
<p>In any table that has ``</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.caa56a14.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>